{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="mb-4">
        <div class="btn-group" role="group" aria-label="Graph Type Navigation">
            <a href="/dashboard/candlestick/" class="btn btn-outline-primary{% if request.path == '/dashboard/candlestick/' %} active{% endif %}">Candlestick</a>
            <a href="/dashboard/line/" class="btn btn-outline-primary{% if request.path == '/dashboard/line/' %} active{% endif %}">Line</a>
            <a href="/dashboard/rsi/" class="btn btn-outline-primary{% if request.path == '/dashboard/rsi/' %} active{% endif %}">RSI</a>
            <a href="/dashboard/bollinger/" class="btn btn-outline-primary{% if request.path == '/dashboard/bollinger/' %} active{% endif %}">Bollinger Bands</a>
            <a href="/dashboard/arima/" class="btn btn-outline-primary{% if request.path == '/dashboard/arima/' %} active{% endif %}">ARIMA/GARCH</a>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col">
            <h1>Line Graph Dashboard</h1>
            <form method="get" class="row g-3 align-items-end mb-4" id="lineForm">
                <div class="col-md-3">
                    <label for="symbolSelect" class="form-label">Stocks</label>
                    <select name="symbols" id="symbolSelect" class="form-select dark-select" multiple>
                        {% for s in all_symbols %}
                        <option value="{{ s }}" {% if s in selected_symbols %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="fieldSelect" class="form-label">Fields</label>
                    <select name="fields" id="fieldSelect" class="form-select dark-select" multiple>
                        {% for f in fields %}
                        <option value="{{ f }}" {% if f in selected_fields %}selected{% endif %}>{{ f|capfirst }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" name="start" id="startDate" class="form-control dark-select" value="{{ start_date }}">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" name="end" id="endDate" class="form-control dark-select" value="{{ end_date }}">
                </div>
                <div class="col-md-2">
                    <label for="maRange" class="form-label">Moving Avg</label>
                    <input type="number" id="maRange" name="ma" class="form-control dark-select" min="1" max="60" value="{{ ma|default:1 }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <a href="/dashboard/line/" class="btn btn-primary w-100">Reset</a>
                </div>
            </form>
            {% if data_json and data_json == '{}' %}
                <p class="text-warning">No data available for the selected parameters</p>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Line Chart</h5>
                    <div id="lineChart"></div>
                    <div id="d3-tooltip" class="tooltip" style="opacity:0; position:absolute;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ selected_symbols|json_script:"selected-symbols-data" }}
<script id="raw-data-json" type="application/json">{{ data_json|safe }}</script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
$(document).ready(function() {
    $('#symbolSelect').select2({ placeholder: 'Select symbols' });
    $('#fieldSelect').select2({ placeholder: 'Select fields' });
    
    const selectedSymbols = JSON.parse(document.getElementById('selected-symbols-data').textContent);
    const rawData = JSON.parse(document.getElementById('raw-data-json').textContent);
    const selectedFields = JSON.parse('{{ selected_fields|safe|escapejs }}'.replace(/'/g, '"'));

    if (Object.keys(rawData).length > 0) {
        drawLineChart(selectedSymbols, rawData, selectedFields);
    }
    
    // Redraw chart on any form change for interactivity
    $('#lineForm input, #lineForm select').on('change', function() {
        const updatedSelectedSymbols = $('#symbolSelect').val();
        const updatedSelectedFields = $('#fieldSelect').val();
        
        // Don't submit the form, just redraw the chart
        if ($(this).attr('name') === 'symbols' || $(this).attr('name') === 'fields' || $(this).attr('name') === 'start' || $(this).attr('name') === 'end') {
            $('#lineForm').submit();
        } else {
             drawLineChart(updatedSelectedSymbols, rawData, updatedSelectedFields);
        }
    });
});
function drawLineChart(selectedSymbols, rawData, selectedFields) {
    const maWindow = parseInt(document.getElementById('maRange').value) || 1;
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    
    function movingAverage(data, windowSize, valueKey) {
        if (!data) return [];
        if (windowSize <= 1) return data.map(d => ({...d, ma: d[valueKey]}));
        let result = [];
        for (let i = 0; i < data.length; i++) {
            if (i < windowSize - 1) {
                result.push({...data[i], ma: null});
            } else {
                const windowSlice = data.slice(i - windowSize + 1, i + 1);
                const avg = d3.mean(windowSlice, d => d[valueKey]);
                result.push({...data[i], ma: avg});
            }
        }
        return result;
    }

    d3.select("#lineChart").selectAll("svg").remove();
    const container = d3.select("#lineChart").node();
    if (!container) return;
    const containerWidth = container.getBoundingClientRect().width;
    const margin = {top: 40, right: 30, bottom: 50, left: 60},
          width = containerWidth - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;
          
    const svg = d3.select("#lineChart")
      .append("svg")
        .attr("width", containerWidth)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
        
    let allDates = new Set();
    selectedSymbols.forEach((sym) => {
        (rawData[sym] || []).forEach(d => allDates.add(d.date));
    });
    allDates = Array.from(allDates).sort();
    
    const x = d3.scaleBand()
      .domain(allDates.map(d => new Date(d)))
      .range([0, width])
      .padding(0.1);
      
    let allValues = [];
    selectedSymbols.forEach(sym => {
        selectedFields.forEach(field => {
            (rawData[sym] || []).forEach(d => {
                if (d[field] !== undefined && d[field] !== null) allValues.push(d[field]);
            });
            const maData = movingAverage(rawData[sym] || [], maWindow, field);
            maData.forEach(d => { if (d.ma !== null && d.ma !== undefined) allValues.push(d.ma); });
        });
    });
    
    if (allValues.length === 0) return;

    const y = d3.scaleLinear()
      .domain(d3.extent(allValues))
      .nice()
      .range([height, 0]);
      
    svg.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y-%m-%d")).tickValues(x.domain().filter((d, i) => !(i % Math.ceil(allDates.length / 20)))))
      .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");
        
    svg.append("g")
      .call(d3.axisLeft(y));
      
    const tooltip = d3.select("#d3-tooltip");
    function showTooltip(event, d, sym, field) {
        tooltip.transition().duration(100).style("opacity", 1);
        tooltip.html(
            `<strong>${sym} (${field})</strong><br>` +
            `<span>${d3.timeFormat('%Y-%m-%d')(new Date(d.date))}</span><br>` +
            `MA(${maWindow}): <span style='color:#0d6efd'>${d.ma?.toFixed(2)}</span>`
        );
        const chartRect = container.getBoundingClientRect();
        tooltip.style("left", (event.pageX - chartRect.left + 10) + "px")
               .style("top", (event.pageY - chartRect.top - 30) + "px");
    }
    
    function hideTooltip() {
        tooltip.transition().duration(200).style("opacity", 0);
    }
    
    let colorIndex = 0;
    selectedSymbols.forEach((sym) => {
        selectedFields.forEach((field) => {
            const data = (rawData[sym] || []).map(d => ({...d, date: new Date(d.date)}));
            const maData = movingAverage(data, maWindow, field).filter(d => d.ma !== null);
            
            svg.append("path")
                .datum(maData)
                .attr("fill", "none")
                .attr("stroke", colorScale(colorIndex))
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(d => x(d.date) + x.bandwidth()/2)
                    .y(d => y(d.ma))
                );
                
            svg.selectAll(`.ma-dot-${sym}-${field}`)
                .data(maData)
                .join("circle")
                .attr("class", `ma-dot-${sym}-${field}`)
                .attr("cx", d => x(d.date) + x.bandwidth()/2)
                .attr("cy", d => y(d.ma))
                .attr("r", 2)
                .attr("fill", colorScale(colorIndex))
                .on("mouseover", (event, d) => showTooltip(event, d, sym, field))
                .on("mouseout", hideTooltip);
            colorIndex++;
        });
    });
    
    const legend = svg.append("g").attr("class", "chart-legend").attr("transform", `translate(0,-30)`);
    colorIndex = 0;
    selectedSymbols.forEach((sym) => {
        selectedFields.forEach((field) => {
            const legendItem = legend.append("g").attr("class", "legend-item").attr("transform", `translate(${colorIndex*180},0)`);
            legendItem.append("rect").attr("width", 18).attr("height", 6).attr("fill", colorScale(colorIndex));
            legendItem.append("text").attr("x", 24).attr("y", 12).text(`${sym} (${field})`).style("fill", colorScale(colorIndex)).style("font-size", "14px");
            colorIndex++;
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('lineForm');
    form.querySelectorAll('input, select').forEach(function(el) {
        el.addEventListener('change', function() {
            form.submit();
        });
    });
});
</script>
{% endblock %} 