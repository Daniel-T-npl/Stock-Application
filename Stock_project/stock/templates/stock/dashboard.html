{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>Stock Dashboard</h1>
            {% if error %}
            <div class="alert alert-danger">
                Error: {{ error }}
            </div>
            {% endif %}
            <form method="get" class="form-inline">
                <select name="symbol" class="form-control mr-2" onchange="this.form.submit()">
                    {% if symbols %}
                        {% for s in symbols %}
                        <option value="{{ s }}" {% if s == symbol %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="">No symbols available</option>
                    {% endif %}
                </select>
                <select name="days" class="form-control mr-2" onchange="this.form.submit()">
                    <option value="1000" {% if days == 1000 %}selected{% endif %}>All Data</option>
                    <option value="7" {% if days == 7 %}selected{% endif %}>7 days</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>30 days</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>90 days</option>
                    <option value="180" {% if days == 180 %}selected{% endif %}>180 days</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>1 year</option>
                </select>
            </form>
            <p class="text-muted mt-2">Showing data from {{ start_date }} to {{ end_date }}</p>
            {% if data %}
                <p class="text-muted">Number of data points: {{ data|length }}</p>
            {% else %}
                <p class="text-warning">No data available for the selected period</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Price Chart</h5>
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Volume Chart</h5>
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize data from Django template
const chartData = JSON.parse('{{ data|safe }}');
console.log('Chart data:', chartData);

// Price Chart
{% if data %}
new Chart(document.getElementById('priceChart'), {
    type: 'line',
    data: {
        labels: chartData.map(d => d.date),
        datasets: [{
            label: 'Open',
            data: chartData.map(d => d.open),
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1,
            fill: false
        }, {
            label: 'High',
            data: chartData.map(d => d.high),
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1,
            fill: false
        }, {
            label: 'Low',
            data: chartData.map(d => d.low),
            borderColor: 'rgb(54, 162, 235)',
            tension: 0.1,
            fill: false
        }, {
            label: 'Close',
            data: chartData.map(d => d.close),
            borderColor: 'rgb(153, 102, 255)',
            tension: 0.1,
            fill: false
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '{{ symbol }} Price History'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Price'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        }
    }
});
{% endif %}

// Volume Chart
{% if data %}
new Chart(document.getElementById('volumeChart'), {
    type: 'bar',
    data: {
        labels: chartData.map(d => d.date),
        datasets: [{
            label: 'Volume',
            data: chartData.map(d => d.volume),
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '{{ symbol }} Trading Volume'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Volume'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Date'
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %} 