{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="mb-4">
        <div class="btn-group" role="group" aria-label="Graph Type Navigation">
            <a href="/dashboard/candlestick/" class="btn btn-outline-primary{% if request.path == '/dashboard/candlestick/' %} active{% endif %}">Candlestick</a>
            <a href="/dashboard/line/" class="btn btn-outline-primary{% if request.path == '/dashboard/line/' %} active{% endif %}">Line</a>
            <a href="/dashboard/rsi/" class="btn btn-outline-primary{% if request.path == '/dashboard/rsi/' %} active{% endif %}">RSI</a>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col">
            <h1>RSI Dashboard</h1>
            <form method="get" class="row g-3 align-items-center" id="rsiForm">
                <div class="col-md-4">
                    <label for="symbolSelect" class="form-label">Stocks</label>
                    <select name="symbols" id="symbolSelect" multiple class="form-select">
                        {% for s in all_symbols %}
                        <option value="{{ s }}" {% if s in selected_symbols %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <label for="rsiPeriod" class="form-label">RSI Period</label>
                    <input type="number" name="period" id="rsiPeriod" class="form-control" min="1" max="50" value="{{ period|default:7 }}">
                </div>
                <div class="col-auto">
                    <label for="startDate" class="form-label">Start</label>
                    <input type="date" name="start" id="startDate" class="form-control" value="{{ start_date }}" min="2021-01-03">
                </div>
                <div class="col-auto">
                    <label for="endDate" class="form-label">End</label>
                    <input type="date" name="end" id="endDate" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-auto">
                    <label for="overbought" class="form-label">Overbought</label>
                    <input type="number" name="overbought" id="overbought" class="form-control" min="1" max="100" value="{{ overbought|default:70 }}">
                </div>
                <div class="col-auto">
                    <label for="oversold" class="form-label">Oversold</label>
                    <input type="number" name="oversold" id="oversold" class="form-control" min="1" max="100" value="{{ oversold|default:30 }}">
                </div>
                <div class="col-auto">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="form-control btn btn-primary">Update</button>
                </div>
            </form>
            {% if data_json and data_json == '{}' %}
                <p class="text-warning">No data available for the selected parameters</p>
            {% endif %}
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">RSI Chart</h5>
                    <div id="rsiChart"></div>
                    <div id="d3-tooltip" class="tooltip" style="opacity:0; position:absolute;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{{ selected_symbols|json_script:"selected-symbols-data" }}
<script id="raw-data-json" type="application/json">{{ data_json|safe }}</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
$(document).ready(function() {
    $('#symbolSelect').select2({ placeholder: 'Select symbols' });
    $('#overbought, #oversold').on('input', function() {
        let ob = parseInt($('#overbought').val());
        let os = parseInt($('#oversold').val());
        if (ob <= os) {
            if ($(this).attr('id') === 'overbought') {
                $('#oversold').val(ob - 1);
            } else {
                $('#overbought').val(os + 1);
            }
        }
    });
});

const selectedSymbols = JSON.parse(document.getElementById('selected-symbols-data').textContent);
const rawData = JSON.parse(document.getElementById('raw-data-json').textContent);
const rsiPeriod = parseInt('{{ period|default:14 }}');
const overbought = Math.max(parseInt('{{ overbought|default:70 }}'), parseInt('{{ oversold|default:30 }}') + 1);
const oversold = Math.min(parseInt('{{ oversold|default:30 }}'), overbought - 1);

// Color palette for stocks
const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

// Helper: Calculate RSI
function calculateRSI(data, period) {
    let gains = [], losses = [];
    // Calculate price changes
    for (let i = 1; i < data.length; i++) {
        const change = data[i].close - data[i-1].close;
        gains.push(change > 0 ? change : 0);
        losses.push(change < 0 ? -change : 0);
    }
    
    // Calculate initial averages
    const initialAvgGain = d3.mean(gains.slice(0, period));
    const initialAvgLoss = d3.mean(losses.slice(0, period));
    
    let avgGain = initialAvgGain;
    let avgLoss = initialAvgLoss;
    let rsiValues = new Array(period).fill(null);
    
    // Calculate first RSI
    if (avgLoss === 0) {
        rsiValues.push(100);
    } else {
        const rs = avgGain / avgLoss;
        rsiValues.push(100 - (100 / (1 + rs)));
    }
    
    // Calculate subsequent RSIs
    for (let i = period + 1; i < data.length; i++) {
        avgGain = ((avgGain * (period - 1)) + gains[i-1]) / period;
        avgLoss = ((avgLoss * (period - 1)) + losses[i-1]) / period;
        
        if (avgLoss === 0) {
            rsiValues.push(100);
        } else {
            const rs = avgGain / avgLoss;
            rsiValues.push(100 - (100 / (1 + rs)));
        }
    }
    
    return data.map((d, i) => ({
        date: d.date,
        rsi: rsiValues[i]
    }));
}

function drawRSIChart() {
    d3.select("#rsiChart").selectAll("svg").remove();
    const margin = {top: 40, right: 30, bottom: 50, left: 60},
          width = 1300 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;
    
    const svg = d3.select("#rsiChart")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
    
    // Prepare all dates
    let allDates = new Set();
    selectedSymbols.forEach((sym) => {
        (rawData[sym] || []).forEach(d => allDates.add(d.date));
    });
    allDates = Array.from(allDates).sort();
    
    // X scale
    const x = d3.scaleBand()
      .domain(allDates.map(d => new Date(d)))
      .range([0, width])
      .padding(0.1);
    
    // Y scale (RSI is always 0-100)
    const y = d3.scaleLinear()
      .domain([0, 100])
      .range([height, 0]);
    
    // X axis
    svg.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y-%m-%d")).tickValues(x.domain().filter((d, i) => !(i % Math.ceil(allDates.length / 10)))))
      .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");
    
    // Y axis
    svg.append("g")
      .call(d3.axisLeft(y));
    
    // Add overbought/oversold lines
    svg.append("line")
      .attr("x1", 0)
      .attr("x2", width)
      .attr("y1", y(overbought))
      .attr("y2", y(overbought))
      .attr("stroke", "#ff6b6b")
      .attr("stroke-width", 1)
      .attr("stroke-dasharray", "5,5");
    
    svg.append("line")
      .attr("x1", 0)
      .attr("x2", width)
      .attr("y1", y(oversold))
      .attr("y2", y(oversold))
      .attr("stroke", "#51cf66")
      .attr("stroke-width", 1)
      .attr("stroke-dasharray", "5,5");
    
    // Add labels for overbought/oversold lines (move inside chart area)
    svg.append("text")
      .attr("x", width - 120)
      .attr("y", y(overbought) - 5)
      .attr("fill", "#ff6b6b")
      .attr("font-size", 14)
      .text(`Overbought (${overbought})`);
    
    svg.append("text")
      .attr("x", width - 120)
      .attr("y", y(oversold) - 5)
      .attr("fill", "#51cf66")
      .attr("font-size", 14)
      .text(`Oversold (${oversold})`);
    
    // Tooltip
    const tooltip = d3.select("#d3-tooltip");
    function showTooltip(event, d, sym) {
        tooltip.transition().duration(100).style("opacity", 1);
        tooltip.html(
            `<strong>${sym}</strong><br>` +
            `<span>${d3.timeFormat('%Y-%m-%d')(new Date(d.date))}</span><br>` +
            `RSI: <span style='color:#0d6efd'>${d.rsi?.toFixed(2)}</span>`
        );
        const chartRect = document.getElementById('rsiChart').getBoundingClientRect();
        const tooltipNode = tooltip.node();
        const tooltipWidth = tooltipNode.offsetWidth;
        const tooltipHeight = tooltipNode.offsetHeight;
        let xPos = event.clientX - chartRect.left + 60;
        let yPos = event.clientY - chartRect.top + 10;
        if (xPos + tooltipWidth > chartRect.width) {
            xPos = chartRect.width - tooltipWidth - 10;
        }
        if (yPos + tooltipHeight > chartRect.height) {
            yPos = chartRect.height - tooltipHeight - 10;
        }
        tooltip.style("left", xPos + "px").style("top", yPos + "px");
    }
    
    function hideTooltip() {
        tooltip.transition().duration(200).style("opacity", 0);
    }
    
    // Draw RSI lines for each stock
    selectedSymbols.forEach((sym, index) => {
        const data = (rawData[sym] || []).map(d => ({...d, date: new Date(d.date)}));
        const rsiData = calculateRSI(data, rsiPeriod);
        
        // Draw RSI line
        svg.append("path")
            .datum(rsiData.filter(d => d.rsi !== null))
            .attr("fill", "none")
            .attr("stroke", colorScale(index))
            .attr("stroke-width", 2)
            .attr("d", d3.line()
                .x(d => x(d.date) + x.bandwidth()/2)
                .y(d => y(d.rsi))
            );
        
        // Add points for tooltip interaction
        svg.selectAll(`.rsi-dot-${sym}`)
            .data(rsiData.filter(d => d.rsi !== null))
            .join("circle")
            .attr("class", `rsi-dot-${sym}`)
            .attr("cx", d => x(d.date) + x.bandwidth()/2)
            .attr("cy", d => y(d.rsi))
            .attr("r", 3)
            .attr("fill", colorScale(index))
            .attr("opacity", 0)
            .on("mouseover", (event, d) => {
                d3.select(event.target).attr("opacity", 1);
                showTooltip(event, d, sym);
            })
            .on("mouseout", (event) => {
                d3.select(event.target).attr("opacity", 0);
                hideTooltip();
            });
    });
    
    // Add legend
    const legend = svg.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "start")
        .selectAll("g")
        .data(selectedSymbols)
        .join("g")
        .attr("transform", (d, i) => `translate(0,${i * 20})`);

    legend.append("rect")
        .attr("x", width - 100)
        .attr("width", 19)
        .attr("height", 19)
        .attr("fill", (d, i) => colorScale(i));

    legend.append("text")
        .attr("x", width - 75)
        .attr("y", 9.5)
        .attr("dy", "0.32em")
        .text(d => d);
}

// Initial draw
if (Object.keys(rawData).length > 0) {
    drawRSIChart();
}
</script>
{% endblock %} 